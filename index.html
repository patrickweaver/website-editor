<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="description"
      content="A website that edits itself"
      id="page-description"
    />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title id="page-title">Website</title>

    <!-- https://emojicon.dev/ -->
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>ðŸ““</text></svg>"
    />

    <!-- CSS -->
    <style>
      body {
        font-family: "Arial", sans-serif;
        background-color: plum;
        margin: 2rem;
      }

      input,
      textarea {
        font-size: 1rem;
        line-height: 1.2rem;
        padding: 0.5rem;
      }

      textarea {
        width: Calc(100% - 1rem);
        min-height: 6rem;
        font-family: "Arial", sans-serif;
      }

      .editButtons {
        background-color: #ddd;
        padding: 0.5rem;
        margin: 0.5rem 0;
        display: inline-block;
      }

      .editButtons button {
        margin: 0 0.25rem;
      }

      #local-controls {
        background-color: #ddd;
        margin: 4rem 0 1rem;
        padding: 0.5rem 1rem;
      }

      .controls-section {
        width: 100%;
        margin: 0.5em 0 2rem;
      }

      .controls-section label,
      .controls-section input,
      .controls-section textarea,
      .controls-section button {
        display: block;
      }

      .controls-section input,
      .controls-section textarea,
      .controls-section button {
        margin: 0.25rem 0 1rem;
      }

      .controls-section label {
        margin: 0.25rem 0;
      }

      #new-content-modal-wrapper {
        position: fixed;
        width: 100vw;
        height: 100vh;
        top: 0;
        left: 0;
        background-color: hsla(0, 20%, 20%, 80%);
      }

      #new-content-modal {
        margin: 5rem 10% 0;
        background-color: #fff;
        padding: 1rem 2rem;
        width: Calc(80% - 2rem - 2rem); /* 2rem is body margin */
      }

      #new-content-modal li {
        margin: 0.5rem;
      }
    </style>

    <!-- Social -->
    <meta property="og:title" content="Website" id="meta-title" />
    <meta
      property="og:description"
      content="A website that edits itself"
      id="meta-description"
    />
    <meta property="og:image" content="" id="meta-image" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary" id="twitter-card" />
    <meta name="twitter:title" content="Website" id="twitter-title" />
    <meta
      name="twitter:description"
      content="A website that edits itself"
      id="twitter-description"
    />
    <meta name="twitter:image" content="" id="twitter-image" />
    <meta name="twitter:image:alt" content="" id="twitter-image-alt" />
  </head>
  <body>
    <h1>Website</h1>

    <h2>About Me</h2>

    <p>I can update this website locally in my browser.</p>

    <hr id="end-of-document" style="display: none" />

    <!-- JS -->
    <script type="text/javascript" id="js">
      /*
       *   Check for local file:
       */

      const protocol = window.location.protocol;
      if (protocol === "file:") {
        localEditingMode();
      }

      /*
       *   Editng JavaScript only runs locally:
       */

      function localEditingMode() {
        // Constants
        const LOCAL_CONTROLS_ID = "local-controls";
        const NEW_CONTENT_MODAL_WRAPPER = "new-content-modal-wrapper";
        const END_OF_DOC_ID = "end-of-document";

        function makeElementListener(node) {
          return (event) => {
            const node = event.target;
            const content = node.innerHTML;
            let editNode = document.createElement("textarea");
            editNode.classList.add("edit");
            editNode.innerHTML = content;
            node.parentElement.insertBefore(editNode, node);

            const controls = [
              {
                label: "Update",
                getNewContent: (node) => node.value,
              },
              {
                label: "Cancel",
                getNewContent: (_) => content,
              },
            ];

            const originalDisplay = node.style.display;
            node.style.display = "none";
            let buttonNodes = [];
            let buttonsContainerNode = document.createElement("div");
            buttonsContainerNode.classList.add("editButtons");
            node.parentElement.insertBefore(buttonsContainerNode, node);
            controls.forEach((i) => {
              let buttonNode = document.createElement("button");
              buttonNode.innerHTML = i.label;
              buttonNodes.push(buttonNode);
              buttonsContainerNode.insertAdjacentElement(
                "afterbegin",
                buttonNode
              );
              buttonNode.addEventListener("click", function (event) {
                node.innerHTML = i.getNewContent(editNode);
                editNode.remove();
                buttonsContainerNode.remove();
                /*buttonNodes.forEach((j) => {
                  j.remove();
                });*/
                node.style.display = originalDisplay;
              });
            });
          };
        }

        // Text
        document
          .querySelectorAll("h1, h2, h3, h4, h5, h6, p")
          .forEach(function (node) {
            node.addEventListener("click", makeElementListener(node));
          });

        /*
         * Page Controls:
         */

        let localControls = document.createElement("div");
        localControls.id = LOCAL_CONTROLS_ID;
        localControls.innerHTML = `
          <h2>Local Controls</h2>
          <p>This section of the page will only display when viewing the local version of your website by opening the <code>index.html</code> file on your computer.
          <hr/>

          <div class="controls-section">
            <h3>Add Content<h3>
            <button id="add-item">Add Item</button>
          </div>

          <div class="controls-section">
            <h3>Social Media Metadata</h3>
            <label for="edit-page-title">Page Title: </label>
            <input type="text" id="edit-page-title" />
            <label for="edit-page-description">Page Description</label>
            <textarea id="edit-page-description" style="min-height: 2rem"></textarea>
          </div>

          <div class="controls-section">
            <h3>Save Changes</h3>
            <button id="save-changes">Save All Changes to Local File</button>
          </div>
        `;

        function addLocalControls() {
          document
            .getElementById(END_OF_DOC_ID)
            .insertAdjacentElement("afterend", localControls);

          document
            .getElementById("add-item")
            .addEventListener("click", preAddItem);
        }

        addLocalControls();

        /*
         *   Add Content
         */

        function preAddItem() {
          let newContentModal = document.createElement("div");
          newContentModal.id = NEW_CONTENT_MODAL_WRAPPER;
          newContentModal.innerHTML = `
          <div id="new-content-modal">
            <h2>Add New Content</h2>
            <ul>
              <li><button id="add-item-heading">Heading</button></li>
              <li><button id="add-item-paragraph">Text</button></li>
              <li><button id="add-item-image">Image</button></li>
            </ul>
            <button>Cancel</button>
          </div>
        `;

          document.body.insertAdjacentElement("beforeend", newContentModal);

          const addItemButtonIds = [
            "add-item-heading",
            "add-item-paragraph",
            "add-item-image",
          ];

          addItemButtonIds.forEach((buttonId) => {
            document
              .getElementById(buttonId)
              .addEventListener("click", (event) => {
                addItem(
                  event.target.id.slice(
                    "add-item-".length,
                    event.target.id.length
                  )
                );
              });
          });
        }

        function addItem(type) {
          let elementType;
          if (type === "heading") {
            elementType = "h2";
          } else if (type === "paragraph") {
            elementType = "p";
          } else if (type === "image") {
            elementType = "img";
          }

          const newElement = document.createElement(elementType);

          if (type === "heading" || type === "paragraph") {
            newElement.innerHTML = "Your text here";
          }

          document
            .getElementById(END_OF_DOC_ID)
            .insertAdjacentElement("beforebegin", newElement);

          newElement.addEventListener("click", makeElementListener(newElement));

          document.getElementById(NEW_CONTENT_MODAL_WRAPPER).remove();
        }

        /*
         *   Page Metadata
         */

        function metaDataEditor(
          editElementId,
          mainElementId,
          secondaryElementIdArray,
          mainProperty = "content",
          secondaryProperty = "content"
        ) {
          const editElement = document.getElementById(editElementId);
          const mainElement = document.getElementById(mainElementId);
          editElement.value = mainElement[mainProperty];

          editElement.addEventListener("input", (event) => {
            const newValue = editElement.value;
            mainElement[mainProperty] = newValue;
            secondaryElementIdArray.forEach((element) => {
              document.getElementById(element)[secondaryProperty] = newValue;
            });
          });
        }

        metaDataEditor(
          "edit-page-title",
          "page-title",
          ["meta-title", "twitter-title"],
          "innerHTML"
        );

        metaDataEditor("edit-page-description", "page-description", [
          "meta-description",
          "twitter-description",
        ]);

        /*
         *   Save Changes
         */

        document
          .getElementById("save-changes")
          .addEventListener("click", function (event) {
            // Remove local controls:
            localControls.remove();

            const htmlSourceCode = `
            <!DOCTYPE html>
            <html lang="en">
              <head>
                ${document.head.innerHTML}
              </head>
              <body>
                ${document.body.innerHTML}
              </body>
            </html>
          `;
            saveFile(htmlSourceCode);

            // Re-add local controls
            addLocalControls();
          });

        // Chromium only
        // https://developer.mozilla.org/en-US/docs/Web/API/FileSystemWritableFileStream/write
        async function saveFile(data) {
          // create a new handle
          const newHandle = await window.showSaveFilePicker({
            startIn: "desktop",
            suggestedName: "index.html",
            types: [
              {
                description: "HTML",
                accept: {
                  "text/markdown": [".html"],
                },
              },
            ],
          });

          // create a FileSystemWritableFileStream to write to
          const writableStream = await newHandle.createWritable();

          // write our file
          await writableStream.write(data);

          // close the file and write the contents to disk.
          await writableStream.close();
        }
      }
    </script>
  </body>
</html>
