<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="description"
      content="A website that edits itself"
      id="page-description"
    />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title id="page-title">Website</title>

    <!-- https://emojicon.dev/ -->
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>ðŸ““</text></svg>"
    />

    <!-- CSS -->
    <style>
      body {
        font-family: "Arial", sans-serif;
        background-color: plum;
        margin: 2rem;
      }

      input,
      textarea {
        font-size: 1rem;
        line-height: 1.2rem;
        padding: 0.5rem;
      }

      textarea {
        width: Calc(100% - 1rem);
        min-height: 6rem;
        font-family: "Arial", sans-serif;
      }

      .editButtons {
        background-color: #ddd;
        padding: 0.5rem;
        margin: 0.5rem 0;
        display: inline-block;
      }

      .editButtons button {
        margin: 0 0.25rem;
      }

      #local-controls {
        background-color: #ddd;
        margin: 4rem 0 1rem;
        padding: 0.5rem 1rem;
      }

      .controls-section {
        width: 100%;
        margin: 0.5em 0;
      }

      .controls-section label,
      .controls-section input,
      .controls-section textarea,
      .controls-section button {
        display: block;
      }

      .controls-section input,
      .controls-section textarea,
      .controls-section button {
        margin: 0.25rem 0 1rem;
      }

      .controls-section label {
        margin: 0.25rem 0;
      }
    </style>

    <!-- Social -->
    <meta property="og:title" content="Website" id="meta-title" />
    <meta
      property="og:description"
      content="A website that edits itself"
      id="meta-description"
    />
    <meta property="og:image" content="" id="meta-image" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary" id="twitter-card" />
    <meta name="twitter:title" content="Website" id="twitter-title" />
    <meta
      name="twitter:description"
      content="A website that edits itself"
      id="twitter-description"
    />
    <meta name="twitter:image" content="" id="twitter-image" />
    <meta name="twitter:image:alt" content="" id="twitter-image-alt" />
  </head>
  <body>
    <h1>Website</h1>

    <h2>About Me</h2>

    <p>I can update this website locally in my browser.</p>

    <!-- JS -->
    <script type="text/javascript" id="js">
      // Text
      document
        .querySelectorAll("h1, h2, h3, h4, h5, h6, p")
        .forEach(function (node) {
          node.addEventListener("click", function (event) {
            const node = event.target;
            const content = node.innerHTML;
            let editNode = document.createElement("textarea");
            editNode.classList.add("edit");
            editNode.innerHTML = content;
            node.parentElement.insertBefore(editNode, node);

            const controls = [
              {
                label: "Update",
                getNewContent: (node) => node.value,
              },
              {
                label: "Cancel",
                getNewContent: (_) => content,
              },
            ];

            const originalDisplay = node.style.display;
            node.style.display = "none";
            let buttonNodes = [];
            let buttonsContainerNode = document.createElement("div");
            buttonsContainerNode.classList.add("editButtons");
            node.parentElement.insertBefore(buttonsContainerNode, node);
            controls.forEach((i) => {
              let buttonNode = document.createElement("button");
              buttonNode.innerHTML = i.label;
              buttonNodes.push(buttonNode);
              buttonsContainerNode.insertAdjacentElement(
                "afterBegin",
                buttonNode
              );
              buttonNode.addEventListener("click", function (event) {
                node.innerHTML = i.getNewContent(editNode);
                editNode.remove();
                buttonsContainerNode.remove();
                /*buttonNodes.forEach((j) => {
                  j.remove();
                });*/
                node.style.display = originalDisplay;
              });
            });
          });
        });

      /*
       * Show Local Controls Locally
       */

      const protocol = window.location.protocol;
      if (protocol === "file:") {
        let localControls = document.createElement("div");
        localControls.innerHTML = `
          <div id="local-controls">
            <h2>Local Controls</h2>
            <p>This section of the page will only display when viewing the local version of your website by opening the <code>index.html</code> file on your computer.
            <hr/>

            <div class="controls-section">
              <h3>Social Media Metadata</h3>
              <label for="edit-page-title">Page Title: </label>
              <input type="text" id="edit-page-title" />
              <label for="edit-page-description">Page Description</label>
              <textarea id="edit-page-description" style="min-height: 2rem"></textarea>
            </div>

            <div class="controls-section">
              <h3>Save Changes</h3>
              <button id="save-changes">Save All Changes to Local File</button>
            </div>
          </div>
        `;

        document
          .getElementById("js")
          .insertAdjacentElement("beforeBegin", localControls);
      }

      /*
       *   Page Metadata
       */

      function metaDataEditor(
        editElementId,
        mainElementId,
        secondaryElementIdArray,
        mainProperty = "content",
        secondaryProperty = "content"
      ) {
        const editElement = document.getElementById(editElementId);
        const mainElement = document.getElementById(mainElementId);
        editElement.value = mainElement[mainProperty];

        editElement.addEventListener("input", (event) => {
          const newValue = editElement.value;
          mainElement[mainProperty] = newValue;
          secondaryElementIdArray.forEach((element) => {
            document.getElementById(element)[secondaryProperty] = newValue;
          });
        });
      }

      metaDataEditor(
        "edit-page-title",
        "page-title",
        ["meta-title", "twitter-title"],
        "innerHTML"
      );

      metaDataEditor("edit-page-description", "page-description", [
        "meta-description",
        "twitter-description",
      ]);

      /*
       *   Save Changes
       */

      document
        .getElementById("save-changes")
        .addEventListener("click", function (event) {
          const htmlSourceCode = `
            <html lang="en">
              ${document.head.innerHTML}
              ${document.body.innerHTML}
            </html>
          `;
          saveFile(htmlSourceCode);
        });

      // Chromium only
      // https://developer.mozilla.org/en-US/docs/Web/API/FileSystemWritableFileStream/write
      async function saveFile(data) {
        // create a new handle
        const newHandle = await window.showSaveFilePicker({
          startIn: "desktop",
          suggestedName: "index.html",
          types: [
            {
              description: "HTML",
              accept: {
                "text/markdown": [".html"],
              },
            },
          ],
        });

        // create a FileSystemWritableFileStream to write to
        const writableStream = await newHandle.createWritable();

        // write our file
        await writableStream.write(data);

        // close the file and write the contents to disk.
        await writableStream.close();
      }
    </script>
  </body>
</html>
