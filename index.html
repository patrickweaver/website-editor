<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="description"
      content="A website that edits itself"
      id="page-description"
    />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title id="page-title">Website</title>

    <!-- https://emojicon.dev/ -->
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>ðŸ““</text></svg>"
    />

    <!-- CSS -->
    <style>
      body {
        font-family: "Arial", sans-serif;
        background-color: plum;
        margin: 2rem;
      }

      .image-container {
        width: 100%;
      }

      input,
      textarea {
        font-size: 1rem;
        line-height: 1.2rem;
        padding: 0.5rem;
      }

      textarea {
        width: Calc(100% - 1rem);
        min-height: 6rem;
        font-family: "Arial", sans-serif;
      }

      label.edit,
      input.edit {
        width: 100%;
      }

      .editButtons {
        background-color: #ddd;
        padding: 0.5rem;
        margin: 0.5rem 0;
        display: inline-block;
      }

      .editButtons button {
        margin: 0 0.25rem;
      }

      #local-controls {
        background-color: #ddd;
        margin: 4rem 0 1rem;
        padding: 0.5rem 1rem;
      }

      .controls-section {
        width: 100%;
        margin: 0.5em 0 2rem;
      }

      .controls-section label,
      .controls-section input,
      .controls-section textarea,
      .controls-section button {
        display: block;
      }

      .controls-section input,
      .controls-section textarea,
      .controls-section button {
        margin: 0.25rem 0 1rem;
      }

      .controls-section label {
        margin: 0.25rem 0;
      }

      #new-content-modal-wrapper {
        position: fixed;
        width: 100vw;
        height: 100vh;
        top: 0;
        left: 0;
        background-color: hsla(0, 20%, 20%, 80%);
      }

      #new-content-modal {
        margin: 5rem 10% 0;
        background-color: #fff;
        padding: 1rem 2rem;
        width: Calc(80% - 2rem - 2rem); /* 2rem is body margin */
      }

      #new-content-modal li {
        margin: 0.5rem;
      }
    </style>

    <!-- Social -->
    <meta property="og:title" content="Website" id="meta-title" />
    <meta
      property="og:description"
      content="A website that edits itself"
      id="meta-description"
    />
    <meta property="og:image" content="" id="meta-image" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary" id="twitter-card" />
    <meta name="twitter:title" content="Website" id="twitter-title" />
    <meta
      name="twitter:description"
      content="A website that edits itself"
      id="twitter-description"
    />
    <meta name="twitter:image" content="" id="twitter-image" />
    <meta name="twitter:image:alt" content="" id="twitter-image-alt" />
  </head>
  <body>
    <h1>Website</h1>

    <h2>About Me</h2>

    <p>I can update this website locally in my browser.</p>

    <hr id="end-of-document" style="display: none" />

    <!-- JS -->
    <script type="text/javascript" id="js">
      /*
       *   Check for local file:
       */

      const protocol = window.location.protocol;
      if (protocol === "file:") {
        localEditingMode();
      }

      /*
       *   Editng JavaScript only runs locally:
       */

      function uniqueId(readableString) {
        return `${readableString}-${Math.random()}`;
      }

      function localEditingMode() {
        // Constants
        const ADD_ITEM_ID = "add-item";
        const ADD_ITEM_HEADING_ID = "add-item-heading";
        const ADD_ITEM_IMAGE_ID = "add-item-image";
        const ADD_ITEM_PARAGRAPH_ID = "add-item-paragraph";
        const IMAGE_CONTAINER_CLASS = "image-container";
        const IMAGE_PICKER_ID_READABLE_STRING = "image-picker";
        const END_OF_DOC_ID = "end-of-document";
        const LOCAL_CONTROLS_ID = "local-controls";
        const NEW_CONTENT_MODAL_WRAPPER = "new-content-modal-wrapper";
        const EDITABLE_TEXT_ELEMENTS = [
          "h1",
          "h2",
          "h3",
          "h4",
          "h5",
          "h6",
          "p",
        ].join(", ");

        const STRINGS = {
          BUTTON_CANCEL: "Cancel",
          BUTTON_UPDATE: "Update",
          ERROR_IMAGE_ONLY: "Error: Please choose an image file",
          LABEL_IMAGE_PICKER: "Choose a new image",
          PLACEHOLDER_TEXT: "Your text here",
        };

        const NEW_CONTENT_MODAL_HTML = `
          <div id="new-content-modal">
            <h2>Add New Content</h2>
            <ul>
              <li><button id="${ADD_ITEM_HEADING_ID}">Heading</button></li>
              <li><button id="${ADD_ITEM_PARAGRAPH_ID}">Text</button></li>
              <li><button><label class="label-button" for="${ADD_ITEM_IMAGE_ID}">Image</label><input type="file" id="${ADD_ITEM_IMAGE_ID}" style="display: none" /></button></li>
            </ul>
            <button>Cancel</button>
          </div>
        `;

        const LOCAL_CONTROLS_HTML = `
          <h2>Local Controls</h2>
          <p>This section of the page will only display when viewing the local version of your website by opening the <code>index.html</code> file on a computer.
          <hr/>

          <div class="controls-section">
            <h3>Add Content<h3>
            <button id="${ADD_ITEM_ID}">Add Item</button>
          </div>

          <div class="controls-section">
            <h3>Social Media Metadata</h3>
            <label for="edit-page-title">Page Title: </label>
            <input type="text" id="edit-page-title" />
            <label for="edit-page-description">Page Description</label>
            <textarea id="edit-page-description" style="min-height: 2rem"></textarea>
          </div>

          <div class="controls-section">
            <h3>Save Changes</h3>
            <button id="save-changes">Save All Changes to Local File</button>
          </div>
        `;

        function makeImageElementListener(element) {
          return (event) => {
            const element = event.target;
            const originalDisplay = element.style.display;
            // // Parent element is .image-container div
            // const content = element.parentElement.innerHTML;
            const imagePickerId = uniqueId(IMAGE_PICKER_ID_READABLE_STRING);
            let removeAfter = [];
            let imagePicker = document.createElement("input");
            removeAfter.push(imagePicker);
            imagePicker.type = "file";
            imagePicker.id = imagePickerId;
            imagePicker.classList.add("edit");
            let imagePickerLabel = document.createElement("label");
            removeAfter.push(imagePickerLabel);
            imagePickerLabel.innerHTML = STRINGS.LABEL_IMAGE_PICKER;
            imagePickerLabel.for = imagePickerId;
            imagePickerLabel.classList.add("edit");
            element.insertAdjacentElement("beforebegin", imagePickerLabel);
            element.insertAdjacentElement("beforebegin", imagePicker);

            element.style.display = "none";

            const controls = [
              {
                label: STRINGS.BUTTON_CANCEL,
                getNewContent: (_) => content,
              },
            ];

            let buttonElements = [];
            let buttonsContainerElement = document.createElement("div");
            buttonsContainerElement.classList.add("editButtons");
            element.parentElement.insertBefore(
              buttonsContainerElement,
              element
            );

            function clearUpdateImageUI() {
              imagePickerLabel.remove();
              imagePicker.remove();
              buttonsContainerElement.remove();
            }

            controls.forEach((i) => {
              let buttonElement = document.createElement("button");
              buttonElement.innerHTML = i.label;
              buttonElements.push(buttonElement);
              buttonsContainerElement.insertAdjacentElement(
                "afterbegin",
                buttonElement
              );
              buttonElement.addEventListener("click", function (event) {
                clearUpdateImageUI();
                element.style.display = originalDisplay;
              });
            });

            document
              .getElementById(imagePickerId)
              .addEventListener("change", () => {
                element.remove();
                addImage({ filePickerId: imagePickerId, update: true });
                clearUpdateImageUI();
              });
          };
        }

        function makeTextElementListener(element) {
          return (event) => {
            const element = event.target;
            const content = element.innerHTML;
            let editElement = document.createElement("textarea");
            editElement.classList.add("edit");
            editElement.innerHTML = content;
            element.parentElement.insertBefore(editElement, element);
            const originalDisplay = element.style.display;
            element.style.display = "none";

            const controls = [
              {
                label: STRINGS.BUTTON_UPDATE,
                getNewContent: (element) => element.value,
              },
              {
                label: STRINGS.BUTTON_CANCEL,
                getNewContent: (_) => content,
              },
            ];

            let buttonElements = [];
            let buttonsContainerElement = document.createElement("div");
            buttonsContainerElement.classList.add("editButtons");
            element.parentElement.insertBefore(
              buttonsContainerElement,
              element
            );
            controls.forEach((i) => {
              let buttonElement = document.createElement("button");
              buttonElement.innerHTML = i.label;
              buttonElements.push(buttonElement);
              buttonsContainerElement.insertAdjacentElement(
                "afterbegin",
                buttonElement
              );
              buttonElement.addEventListener("click", function (event) {
                element.innerHTML = i.getNewContent(editElement);
                editElement.remove();
                buttonsContainerElement.remove();
                /*buttonElements.forEach((j) => {
                  j.remove();
                });*/
                element.style.display = originalDisplay;
              });
            });
          };
        }

        // Text
        document
          .querySelectorAll(EDITABLE_TEXT_ELEMENTS)
          .forEach(function (element) {
            element.addEventListener("click", makeTextElementListener(element));
          });

        /*
         * Page Controls:
         */

        let localControls = document.createElement("div");
        localControls.id = LOCAL_CONTROLS_ID;
        localControls.innerHTML = LOCAL_CONTROLS_HTML;

        function addLocalControls() {
          document
            .getElementById(END_OF_DOC_ID)
            .insertAdjacentElement("afterend", localControls);

          document
            .getElementById(ADD_ITEM_ID)
            .addEventListener("click", preAddItem);
        }

        addLocalControls();

        /*
         *   Add Content
         */

        function preAddItem() {
          let newContentModal = document.createElement("div");
          newContentModal.id = NEW_CONTENT_MODAL_WRAPPER;
          newContentModal.innerHTML = NEW_CONTENT_MODAL_HTML;

          document.body.insertAdjacentElement("beforeend", newContentModal);

          const addItemButtonIds = [ADD_ITEM_HEADING_ID, ADD_ITEM_PARAGRAPH_ID];

          addItemButtonIds.forEach((buttonId) => {
            document
              .getElementById(buttonId)
              .addEventListener("click", (event) => {
                addTextItem(
                  event.target.id.slice(
                    // ðŸš¸ This is fragile with the strings coming from the constants above.
                    "add-item-".length,
                    event.target.id.length
                  )
                );
              });
          });

          document
            .getElementById(ADD_ITEM_IMAGE_ID)
            .addEventListener("change", () =>
              addImage({ filePickerId: ADD_ITEM_IMAGE_ID })
            );
        }

        function addImage({ filePickerId, update = false }) {
          const filePicker = document.getElementById(filePickerId);
          const file = filePicker.files[0];
          if (!file.type.startsWith("image/")) {
            alert(STRINGS.ERROR_IMAGE_ONLY);
            return;
          }
          const imageContainer = document.createElement("div");
          imageContainer.classList.add(IMAGE_CONTAINER_CLASS);
          const newElement = document.createElement("img");
          newElement.file = file;
          // Add imageContainer to end of current document
          document
            .getElementById(END_OF_DOC_ID)
            .insertAdjacentElement("beforebegin", imageContainer);
          // Add img element inside imageContainer
          imageContainer.insertAdjacentElement("afterbegin", newElement);
          // Set img src to file contents as Data URL
          const reader = new FileReader();
          reader.onload = ((aImg) => {
            return (e) => {
              aImg.src = e.target.result;
            };
          })(newElement);
          reader.readAsDataURL(file);
          // Remove new
          if (!update) {
            document.getElementById(NEW_CONTENT_MODAL_WRAPPER).remove();
          }

          newElement.addEventListener(
            "click",
            makeImageElementListener(newElement)
          );
        }

        function addTextItem(type) {
          let elementType;
          if (type === "heading") {
            elementType = "h2";
          } else if (type === "paragraph") {
            elementType = "p";
          }

          const newElement = document.createElement(elementType);

          if (type === "heading" || type === "paragraph") {
            newElement.innerHTML = STRINGS.PLACEHOLDER_TEXT;

            document
              .getElementById(END_OF_DOC_ID)
              .insertAdjacentElement("beforebegin", newElement);

            newElement.addEventListener(
              "click",
              makeTextElementListener(newElement)
            );

            document.getElementById(NEW_CONTENT_MODAL_WRAPPER).remove();
          }
        }

        /*
         *   Page Metadata
         */

        function metaDataEditor(
          editElementId,
          mainElementId,
          secondaryElementIdArray,
          mainProperty = "content",
          secondaryProperty = "content"
        ) {
          const editElement = document.getElementById(editElementId);
          const mainElement = document.getElementById(mainElementId);
          editElement.value = mainElement[mainProperty];

          editElement.addEventListener("input", (event) => {
            const newValue = editElement.value;
            mainElement[mainProperty] = newValue;
            secondaryElementIdArray.forEach((element) => {
              document.getElementById(element)[secondaryProperty] = newValue;
            });
          });
        }

        metaDataEditor(
          "edit-page-title",
          "page-title",
          ["meta-title", "twitter-title"],
          "innerHTML"
        );

        metaDataEditor("edit-page-description", "page-description", [
          "meta-description",
          "twitter-description",
        ]);

        /*
         *   Save Changes
         */

        document
          .getElementById("save-changes")
          .addEventListener("click", function (event) {
            // Remove local controls:
            localControls.remove();

            const htmlSourceCode = `
            <!DOCTYPE html>
            <html lang="en">
              <head>
                ${document.head.innerHTML}
              </head>
              <body>
                ${document.body.innerHTML}
              </body>
            </html>
          `;
            saveFile(htmlSourceCode);

            // Re-add local controls
            addLocalControls();
          });

        // Chromium only
        // https://developer.mozilla.org/en-US/docs/Web/API/FileSystemWritableFileStream/write
        async function saveFile(data) {
          // create a new handle
          const newHandle = await window.showSaveFilePicker({
            startIn: "desktop",
            suggestedName: "index.html",
            types: [
              {
                description: "HTML",
                accept: {
                  "text/markdown": [".html"],
                },
              },
            ],
          });

          // create a FileSystemWritableFileStream to write to
          const writableStream = await newHandle.createWritable();

          // write our file
          await writableStream.write(data);

          // close the file and write the contents to disk.
          await writableStream.close();
        }
      }
    </script>
  </body>
</html>
